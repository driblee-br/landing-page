<html>
<!-- SDK loading -->
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>

<script>
    const URL_API = "https://driblee-api-staging.vellune.tech";
    // SDK initialization
    window.fbAsyncInit = function () {
        FB.init({
            appId: '1703147563952436',
            autoLogAppEvents: true,
            xfbml: true,
            version: 'v22.0'
        });
    };

    // Session logging message event listener
    // Substitua o event listener atual por este:
    window.addEventListener('message', (event) => {
        if (!event.origin.includes('facebook.com')) return;

        try {
            // Tenta parsear como JSON primeiro
            let data;
            if (typeof event.data === 'string') {
                try {
                    data = JSON.parse(event.data);
                } catch {
                    // Se falhar, trata como query string
                    const params = new URLSearchParams(event.data);
                    if (params.has('code')) {
                        console.log('Código de autorização recebido:', params.get('code'));
                        // Você pode processar o code aqui se necessário
                        return;
                    }
                    return; // Ignora outras mensagens não-JSON sem code
                }
            } else {
                data = event.data;
            }

            // Processa apenas eventos WA_EMBEDDED_SIGNUP
            if (data?.type === 'WA_EMBEDDED_SIGNUP') {
                console.log('Evento WhatsApp recebido:', data);
                fetch(`${URL_API}/embedded-signup/meta/events`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(response => {
                    if (!response.ok) {
                        console.error('Erro no servidor:', response.status);
                    }
                });
            }
        } catch (error) {
            console.log('Erro ao processar mensagem:', error);
        }
    });

    // Response callback
    const fbLoginCallback = (response) => {
        if (response.authResponse) {
            const code = response.authResponse.code;

            // Envia apenas o code para o backend
            fetch(`${URL_API}/embedded-signup/meta/code`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code })
            })
                .then(response => response.json())
                .then(data => {
                    console.log("Success:", data);
                    if (data.access_token) {
                        // Aqui você tem o access_token e waba_id disponíveis
                        console.log("Access Token:", data.access_token);
                        console.log("WABA ID:", data.waba_id);
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                });
        } else {
            console.log('Login failed:', response);
        }
    }

    // Launch method and callback registration
    const launchWhatsAppSignup = () => {
        FB.login(fbLoginCallback, {
            config_id: '3212942975512497',
            response_type: 'code',
            override_default_response_type: true,
            extras: {
                setup: {},
                featureType: '',
                sessionInfoVersion: '3',
            }
        });
    }
</script>

<!-- Launch button  -->
<button onclick="launchWhatsAppSignup()"
    style="background-color: #1877f2; border: 0; border-radius: 4px; color: #fff; cursor: pointer; font-family: Helvetica, Arial, sans-serif; font-size: 16px; font-weight: bold; height: 40px; padding: 0 24px;">Login
    with Facebook</button>

</html>