<html>
<!-- SDK loading -->
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>

<script>
    //const URL_API = "http://localhost:8086";
    const URL_API = "https://api.driblee.com";
    // SDK initialization
    window.fbAsyncInit = function () {
        FB.init({
            appId: '1703147563952436',
            autoLogAppEvents: true,
            xfbml: true,
            version: 'v22.0'
        });
    };

    // Session logging message event listener
    window.addEventListener('message', async (event) => {
        if (event.origin !== "https://www.facebook.com" && event.origin !== "https://web.facebook.com") return;
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'WA_EMBEDDED_SIGNUP') {
                console.log('message event 1: ', data); // remove after testing
                const response = await fetch(`${URL_API}/api/whatsapp/embedded-signup/events`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                console.log('response 1: ', response); // remove after testing
            }
        } catch {
            console.log('message even 2: ', event.data); // remove after testing
            const response = await fetch(`${URL_API}/api/whatsapp/embedded-signup/events`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    raw: event.data
                })
            });
            console.log('response 2: ', response); // remove after testing
        }
    });

    // Response callback
    const fbLoginCallback = (response) => {
        if (response.authResponse) {
            (async () => {
                const code = response.authResponse.code;

                // Envia apenas o code para o backend para obter o access_token
                const tokenResponse = await fetch(`${URL_API}/api/whatsapp/embedded-signup/code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code })
                });

                const tokenData = await tokenResponse.json();
                const accessToken = tokenData.access_token;

                // Usa o access_token para consultar o waba_id via /debug_token
                const debugTokenUrl = `https://graph.facebook.com/v22.0/debug_token?input_token=${accessToken}`;
                const debugResponse = await fetch(debugTokenUrl, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const debugData = await debugResponse.json();
                const wabaId = debugData?.data?.granular_scopes?.[0]?.target_ids?.[0];

                const body = JSON.stringify({ code, waba_id: wabaId });
                console.log("Body 1:", body);
                console.log('response 1: ', code); // remove after testing

                const backendResponse = await fetch(`${URL_API}/api/whatsapp/embedded-signup/code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: body
                });
                console.log('backendResponse 1: ', backendResponse); // remove after testing
            })();
        } else {
            console.log('response 2: ', response); // remove after testing
            const body = JSON.stringify({ raw: response.data });
            console.log("Body 2:", body);
            const backendResponse = fetch(`${URL_API}/api/whatsapp/embedded-signup/code`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: body
            });
            console.log('backendResponse 2: ', backendResponse); // remove after testing
        }
    }

    // Launch method and callback registration
    const launchWhatsAppSignup = () => {
        FB.login(fbLoginCallback, {
            config_id: '3212942975512497', // your configuration ID goes here
            response_type: 'code',
            override_default_response_type: true,
            extras: {
                setup: {},
                featureType: '',
                sessionInfoVersion: '3',
            }
        });
    }
</script>

<!-- Launch button  -->
<button onclick="launchWhatsAppSignup()"
    style="background-color: #1877f2; border: 0; border-radius: 4px; color: #fff; cursor: pointer; font-family: Helvetica, Arial, sans-serif; font-size: 16px; font-weight: bold; height: 40px; padding: 0 24px;">Login
    with Facebook</button>

</html>