<html>
<!-- SDK loading -->
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>

<script>
    //const URL_API = "http://localhost:8086";
    const URL_API = "https://api.driblee.com";
    // SDK initialization
    window.fbAsyncInit = function () {
        FB.init({
            appId: '1703147563952436',
            autoLogAppEvents: true,
            xfbml: true,
            version: 'v22.0'
        });
    };

    // Session logging message event listener
    window.addEventListener('message', async (event) => {
        if (event.origin !== "https://www.facebook.com" && event.origin !== "https://web.facebook.com") return;
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'WA_EMBEDDED_SIGNUP') {
                console.log('message event 1: ', data); // remove after testing
                const response = await fetch(`${URL_API}/api/whatsapp/embedded-signup/events`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                console.log('response 1: ', response); // remove after testing
            }
        } catch {
            console.log('message even 2: ', event.data); // remove after testing
            const response = await fetch(`${URL_API}/api/whatsapp/embedded-signup/events`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    raw: event.data
                })
            });
            console.log('response 2: ', response); // remove after testing
        }
    });

    // Response callback
    const fbLoginCallback = (response) => {
        if (response.authResponse) {
            const code = response.authResponse.code;

            // Envia apenas o code para o backend
            fetch(`${URL_API}/api/whatsapp/embedded-signup/code`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code })
            })
                .then(response => response.json())
                .then(data => {
                    console.log("Success:", data);
                    if (data.access_token) {
                        // Aqui você tem o access_token e waba_id disponíveis
                        console.log("Access Token:", data.access_token);
                        console.log("WABA ID:", data.waba_id);
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                });
        } else {
            console.log('Login failed:', response);
        }
    }

    // Launch method and callback registration
    const launchWhatsAppSignup = () => {
        FB.login(fbLoginCallback, {
            config_id: '3212942975512497', // your configuration ID goes here
            response_type: 'code',
            override_default_response_type: true,
            extras: {
                setup: {},
                featureType: '',
                sessionInfoVersion: '3',
            }
        });
    }
</script>

<!-- Launch button  -->
<button onclick="launchWhatsAppSignup()"
    style="background-color: #1877f2; border: 0; border-radius: 4px; color: #fff; cursor: pointer; font-family: Helvetica, Arial, sans-serif; font-size: 16px; font-weight: bold; height: 40px; padding: 0 24px;">Login
    with Facebook</button>

</html>